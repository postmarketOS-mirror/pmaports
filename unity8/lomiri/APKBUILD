# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20210414
_commit="2bf97a56bc40cc3da5bfd212cb4c3a54bfaa2961"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components gsettings-ubuntu-touch-schemas qtmir suru-icon-theme gsettings-desktop-schemas unity-system-compositor"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-Add-missing-includes.patch
	0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0004-Link-against-libintl.patch
	no-android.patch
	disable-lights.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel/
}

sha512sums="cf520d797d8a532c60c89b99974403897d35e7290bec9a20a046031cf15165905d9cd384c5e9f58242bba52f679dedf752a1416938ff5f6a1f223242aefdd8fe  lomiri-2bf97a56bc40cc3da5bfd212cb4c3a54bfaa2961.tar.gz
c3528363a396f1a921a21f5d2d8e529878b40800ff0bd3bdddd98a68cbcadf59692d12df04274963660a62ac9c1fff01c8f78f8f2910546aa9cc558b672893b7  0001-NoDpkgParse.patch
526662b9b0c0306ac64d2b10368c539c37c7291e9cb2f4142733b95ec2f9d82cde6a1887837927dc591a84086735f9d0ec665217888ae7b9b4e0a8027c15c4f3  0002-Add-missing-includes.patch
c6b739c4d6142c4bc11d17bcfff6ea54abbf5813c3049c8de457a378de790e32febb721a47a650b9fd4c65abc761c02c1045933d459c940a8e91618b119531a4  0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
e4898804c49a7532c24e4c879c04ae7444e9581ce7559d9a32e3e683cb6a0d3ab1f0e8a12a944d161a37af4a8a071b91f6aef40f6a03766cb89574d70a8e98d1  0004-Link-against-libintl.patch
bd9c798af9d70a71de1a4e390d9a1f1eace8d7d27d744f3c73f0a22866a279b2a40ce5511a59199b4db8af254b81781c3ba5dc1defd645f1fcb326ae9e71472c  no-android.patch
9be867583eb12636cca80dbd377a1325c1435f11ad28973ef912671dca0af00db9bbf26d1dcb568b21a6ab861fb56ba20f63c2558b875a2fc89e0c068795c78c  disable-lights.patch"
