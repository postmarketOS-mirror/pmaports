# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20210414
_commit="2bf97a56bc40cc3da5bfd212cb4c3a54bfaa2961"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components gsettings-ubuntu-touch-schemas qtmir suru-icon-theme gsettings-desktop-schemas lomiri-system-compositor keyboard-component"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-Add-missing-includes.patch
	0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0004-Link-against-libintl.patch
	0005-We-do-not-have-Android-stuff.patch
	0006-Fix-up-gschema.patch
	0007-gmenumodel-isn-t-renamed.patch
	0008-Revert-rename-of-com.lomiri.touch.system-gschema.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel/
}

sha512sums="cf520d797d8a532c60c89b99974403897d35e7290bec9a20a046031cf15165905d9cd384c5e9f58242bba52f679dedf752a1416938ff5f6a1f223242aefdd8fe  lomiri-2bf97a56bc40cc3da5bfd212cb4c3a54bfaa2961.tar.gz
b0ad6b5451b98ca7ccfa89020874215b48053cce8216f6aef06b89e60f86295e460e05f23d680e8b8b7227ce1a5544a7239e5f38c0339dd544be4fa6a75bf99b  0001-NoDpkgParse.patch
30dc0f0f042b8f74bcead9b338f1237dd859742e8568d45dc34af813c1a64e9746b799258af5d6e2d77e146bb39aa1d765b4421d18821663cf3f9fa10e5b156b  0002-Add-missing-includes.patch
10725600257b14853ca261d012a7b6acc1d6b47d67a0465620e421ac09e60a332e48c0bb8d77b623ddc9d238e10803afadd4caf8559d620b751c9f5ce38f320d  0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
2a76841c3f51b958944dbbf3c3a0af26ba5358ecaf8676d0391f27671a474928c896194c7b7dce00936781155ba258d2e60d84987dbd913365352e7e4c7db67a  0004-Link-against-libintl.patch
61e6448bebb8faf3c1cfb13516899664f0b05b72e9ac8684d7f3a965bed6de0f3f2465adfa558546f375749dd6ced949999275ef45152c51edd84c99d63e3393  0005-We-do-not-have-Android-stuff.patch
1e1b5ca49ccbff69a8e2977ca1ef52b6e209304e71dff5e0062c51851f9f5d6ef9e8df4c6d00391841c231a22445bd262200bc3e34ff5b05cfdd0f0447896e55  0006-Fix-up-gschema.patch
251a6f95219ea9d47ee41321926d37a6aa2e8272c61db91e1cf8d8fbc4faf106eaf2f31a8d5aaff28a95749f3ce352d5357136ce48a1216e0e409cb1e27e5b19  0007-gmenumodel-isn-t-renamed.patch
b1d8a066df21993cda018584042d715dae986056ebe140912f8dd74a1817051f537c54684a96152217fc4533766b6b8c3fc58856f2eab0a6d954ffc8bfbabd96  0008-Revert-rename-of-com.lomiri.touch.system-gschema.patch"
