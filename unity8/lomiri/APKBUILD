# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20210622
# https://gitlab.com/ubports/core/lomiri/-/merge_requests/8
_commit="a0b8eb2adf08ac6b97486c20357bdb83892b2e99"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components gsettings-ubuntu-touch-schemas qtmir suru-icon-theme gsettings-desktop-schemas lomiri-system-compositor keyboard-component"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev elogind-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-Add-missing-includes.patch
	0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0004-Link-against-libintl.patch
	0005-We-do-not-have-Android-stuff.patch
	0006-No-systemd.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Tests fail

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel/
}

sha512sums="
1712dc4eb19ba1e2a3a6318ff3a788d74a5970c2d0472de383b8a9ff34c2d4422c9a4e241319770eb860ef41690a41ba44b1086beb241df6c0809e68c033d4a4  lomiri-a0b8eb2adf08ac6b97486c20357bdb83892b2e99.tar.gz
ca82517720e33e348d95636622be7e5c19a0eacd39065f2205cf320ba1da02745bc1c135552236d83a20882281a353df819b54810b7ccc0089e7fed5f041304c  0001-NoDpkgParse.patch
99ba3b5cfe5b5b8bad200336028c7c5fd61e1a863f653e84ab433a6062ada7c1f14148044f387f75c98a0539399d5b77ff6640091f1a1b236514e90d84b70376  0002-Add-missing-includes.patch
9480cb038086282196e8fb1380de4b65c20d84ac43cb00672858bd88cf173c645bb56210639dc13d58d5118679e4e985ea9f66632282bfc4ef6a052db8c716be  0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
f818d084565f16fb6fef5d46f1a78eb9cf1beb839010705d602ddda5935637293dac9d7b1cf4f9c668c6823a2dcc6d2b082a8f71fb03b79ca1291916fbfd0006  0004-Link-against-libintl.patch
2a5e4977db5f8cf83ef34230d53f80c958ed54883f6902c2678d8198a0a6d0e8359051e0129818430c1b7663423e066800618f522b64f1deac630becc28ec088  0005-We-do-not-have-Android-stuff.patch
9cb18aba8c71de7baf6355228f41cce4025dae813e8fc7a20996ccc310062be52b030c5c78eb4820c4e352ebe1b3df5ff74212d8328aee1e8b5dcbd91b3f6382  0006-No-systemd.patch
"
