# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri
pkgver=0_git20210520
# https://gitlab.com/ubports/core/lomiri/-/merge_requests/2
_commit="9d6a14b0f4f4a5cc6e9aed3233e905a62c3c3d2b"
pkgrel=0
pkgdesc="A convergent desktop environment"
arch="all"
url="https://gitlab.com/ubports/core/lomiri"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects qt5-qtbase-sqlite lomiri-settings-components gsettings-ubuntu-touch-schemas qtmir suru-icon-theme gsettings-desktop-schemas lomiri-system-compositor keyboard-component"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev lomiri-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev lomiri-app-launch-dev lomiri-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev lomiri-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz lomiri-system-settings lomiri-deviceinfo-dev"
checkdepends="py3-dbusmock"
source="https://gitlab.com/ubports/core/lomiri/-/archive/$_commit/lomiri-$_commit.tar.gz
	0001-NoDpkgParse.patch
	0002-Add-missing-includes.patch
	0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0004-Link-against-libintl.patch
	0005-We-do-not-have-Android-stuff.patch
	"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"
options="!check" # Tests fail

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	# testRootActionState: RootActionStateTest::testToQVariantIcons() 'serializedIcons[0] == "image://theme/testIcon0"' returned FALSE.
	# testWindowStateStorage: https://github.com/ubports/unity8/issues/316
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWindowStateStorage"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	# conflicts: qmenumodel-0_git20180727-r0[so:libqmenumodel.so.0=0]
	rm -r "$pkgdir"/usr/lib/lomiri/qml/mocks/QMenuModel/
}

sha512sums="
043dd5fe3564e2b375ebafda6a81af20e406f0d10dbcf711e560272bbe8b14cf448f4fe3da102eda0c1b490c1a1209dd5563a87f784f2c2eef482cb3cebc4fd3  lomiri-9d6a14b0f4f4a5cc6e9aed3233e905a62c3c3d2b.tar.gz
c8f51c8efa1acd7ddff6149f9e6f57f1ac0a97d01474cea4db597b8fa6cffda43d1691baeb985f61a19e84d69a460e679e29538c1a008db3b713acedee0bae4d  0001-NoDpkgParse.patch
d1fba54879bc41aa3cc8fc075b752668d81b97f86daee3f9dbcbfe4d8f3f54f2565bd3a427f049085d0064b616f8bb458a11964873ee069b11a50a5e85fe58a6  0002-Add-missing-includes.patch
7bf2e39031ec20bf06c9d44ea216c449cad2c81186237862fbdc37d367ab60bb374eada21cf996105fc96d3f2f0443e55eebe60e5395103d208539b6deb287ec  0003-Add-qt5-suffix-to-search-for-Qt-tools.patch
1e89ac542d00bd34f3ab71b77fd4c8272ff7dd3a65da1f90cee32a130d036a90c5464c60d8db0b0edb01de8210b3d56cfcd57658aa5da026cb923bd719934817  0004-Link-against-libintl.patch
e4d1c32511a60b7a08a11a6e05565e33de2c82b71d5df380ebf63570d84786f8bd9dc8cb248238ecd7126a3516aef35f98126a48fa96264b6a5fb2ad6f54fa8f  0005-We-do-not-have-Android-stuff.patch
"
