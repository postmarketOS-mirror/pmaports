# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri-system-compositor
pkgver=0_git20210520
# https://gitlab.com/ubports/core/lomiri-system-compositor/-/merge_requests/23
_commit="6e6c59138d067430c3c6f8c4fd5a776d8ccbc8f5"
pkgrel=0
pkgdesc="System compositor using the Mir display server"
arch="all"
url="https://gitlab.com/ubports/core/lomiri-system-compositor"
license="GPL-3.0-only"
makedepends="$depends_dev cmake cmake-extras gtest-dev gmock gdk-pixbuf-dev mir-dev dbus-dev lomiri-deviceinfo-dev"
checkdepends="dbus"
source="https://gitlab.com/ubports/core/lomiri-system-compositor/-/archive/$_commit/lomiri-system-compositor-$_commit.tar.gz
	0001-spinner-Add-support-for-wayland-backend.patch
	0002-Add-missing-stdexcept-header-17.patch
	"
builddir="$srcdir/$pkgname-$_commit"

build() {
	# fails to build with fortify headers enabled
	export CXXFLAGS="$CXXFLAGS -U_FORTIFY_SOURCE"

	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

sha512sums="
4d6378274a75f4aa5e7008fe6a877a1ea137e34b6b1ce699b1c9aec3d195f1ce8ade10be9d35c3e710be2c844c292b0a3d3102c440f0668f4ca5afce8e3d42a2  lomiri-system-compositor-6e6c59138d067430c3c6f8c4fd5a776d8ccbc8f5.tar.gz
93f02b1d138797561d14df697fe01afa56af454b6b8c0a5d317d6e62a2dd78d614bd64dfc57b5c16ef18ae42a4a7dadc64a2109ac87392feedc9373f682e05da  0001-spinner-Add-support-for-wayland-backend.patch
d9921be03cacac1e891125852a38fbb1c3789d03dda635cc2f0d4d1f1e2f5e3423bdecf9f27d670dcda81c32fd827846c168d1bd476eb07580b48cb135095e28  0002-Add-missing-stdexcept-header-17.patch
"
