# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=lomiri-system-compositor
pkgver=0_git20210416
_commit="9565fe5eb6b4451b08cb0b31d8020ae411d626a4"
pkgrel=0
pkgdesc="System compositor using the Mir display server"
arch="all"
url="https://gitlab.com/ubports/core/lomiri-system-compositor"
license="GPL-3.0-only"
makedepends="$depends_dev cmake cmake-extras gtest-dev gmock gdk-pixbuf-dev mir-dev dbus-dev lomiri-deviceinfo-dev"
checkdepends="dbus"
source="https://gitlab.com/ubports/core/lomiri-system-compositor/-/archive/$_commit/lomiri-system-compositor-$_commit.tar.gz
	0001-Add-missing-stdexcept-header.patch"
builddir="$srcdir/$pkgname-$_commit"

build() {
	# fails to build with fortify headers enabled
	export CXXFLAGS="$CXXFLAGS -U_FORTIFY_SOURCE"

	cmake -B build \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

sha512sums="bdc758580932c7ca170de30421e522bececbb8877239df761dfadb2fab295f963e798abb98cb5d98be7600a098f092fb41a4271542b5b9eb74b81f74151d3773  lomiri-system-compositor-9565fe5eb6b4451b08cb0b31d8020ae411d626a4.tar.gz
4f2a78f62ff242118f86e7ad25b680521a6faa1f86f7840ac20786dd075499409ff6501d3b691c14b465c62941d646fcbd5ecd907c4749f7e5694ce8baedba0b  0001-Add-missing-stdexcept-header.patch"
